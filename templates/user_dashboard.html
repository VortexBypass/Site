{% extends "base.html" %}

{% block title %}User Dashboard - MooVerify{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1.25rem;
    }

    .stat-card {
        background: rgba(30, 41, 59, 0.8);
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        border-left: 4px solid #38bdf8;
    }

    .stat-card.info {
        border-left-color: #0ea5e9;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        color: #cbd5e1;
        font-size: 0.75rem;
    }

    .action-buttons {
        display: flex;
        gap: 0.6rem;
        margin-bottom: 1.25rem;
        flex-wrap: wrap;
    }

    .api-key {
        font-family: 'Courier New', monospace;
        background: rgba(56, 189, 248, 0.1);
        padding: 0.5rem;
        border-radius: 6px;
        color: #38bdf8;
        word-break: break-all;
        margin: 0.4rem 0;
        font-size: 0.75rem;
        border: 1px solid rgba(56, 189, 248, 0.2);
    }

    .btn-small {
        padding: 0.35rem 0.7rem;
        font-size: 0.7rem;
    }

    .btn-danger {
        background: linear-gradient(45deg, #ef4444, #dc2626);
    }

    .code-block {
        position: relative;
        background: #1e293b;
        border: 1px solid rgba(100, 116, 139, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin: 0.75rem 0;
        font-family: 'Courier New', monospace;
        font-size: 0.75rem;
        line-height: 1.3;
        overflow-x: auto;
        white-space: pre-wrap;
        color: #e2e8f0;
    }

    .copy-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: rgba(30, 41, 59, 0.9);
        border: 1px solid rgba(100, 116, 139, 0.4);
        color: #cbd5e1;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.7rem;
        transition: all 0.2s ease;
    }

    .copy-btn:hover {
        background: rgba(56, 189, 248, 0.2);
        color: #38bdf8;
    }

    .tab-container {
        margin: 1.25rem 0;
    }

    .tabs {
        display: flex;
        border-bottom: 1px solid rgba(100, 116, 139, 0.3);
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .tab {
        padding: 0.6rem 1rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        font-size: 0.85rem;
        white-space: nowrap;
        transition: all 0.2s ease;
    }

    .tab.active {
        border-bottom: 2px solid #38bdf8;
        color: #38bdf8;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .key-item {
        padding: 0.75rem;
        border-bottom: 1px solid rgba(100, 116, 139, 0.2);
    }

    .key-item:last-child {
        border-bottom: none;
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.6rem;
        }
        
        .stat-number {
            font-size: 1.25rem;
        }
        
        .action-buttons {
            gap: 0.5rem;
        }
        
        .tabs {
            overflow-x: auto;
        }
        
        .tab {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }
        
        .code-block {
            font-size: 0.7rem;
            padding: 0.75rem;
        }
    }

    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
        }
        
        .tab {
            padding: 0.4rem 0.6rem;
            font-size: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; flex-wrap: wrap; gap: 0.75rem;">
            <h1 style="font-size: 1.4rem; color: #38bdf8;"><i class="fas fa-tachometer-alt"></i> User Dashboard</h1>
            <div style="color: #cbd5e1; font-size: 0.9rem;">
                Welcome, <strong>{{ session.get('user_username') }}</strong>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" style="color: #38bdf8;">
                    {{ user_data.api_keys|length if user_data.api_keys else 0 }}
                </div>
                <div class="stat-label">API Keys</div>
            </div>
            <div class="stat-card info">
                <div class="stat-number" style="color: #0ea5e9;">24/7</div>
                <div class="stat-label">Uptime</div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn" onclick="generateApiKey()">
                <i class="fas fa-key"></i> Generate API Key
            </button>
            <a href="{{ url_for('user_logout') }}" class="btn btn-secondary">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>

        <div class="tab-container">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('api-keys-tab')">API Keys</div>
                <div class="tab" onclick="switchTab('documentation-tab')">Documentation</div>
            </div>

            <div id="api-keys-tab" class="tab-content active">
                <h3 style="margin-bottom: 0.75rem; font-size: 1.2rem;">Your API Keys</h3>
                {% if user_data.api_keys %}
                    {% for api_key in user_data.api_keys %}
                    <div class="card" style="margin-bottom: 0.75rem; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 0.5rem;">
                            <div style="flex: 1; min-width: 200px;">
                                <div class="api-key">{{ api_key.key }}</div>
                                <div style="color: #cbd5e1; font-size: 0.7rem; margin-top: 0.4rem;">
                                    Created: {{ api_key.created_at }}
                                    {% if api_key.last_used %}
                                    <br>Last Used: {{ api_key.last_used }}
                                    {% endif %}
                                </div>
                            </div>
                            <button class="btn btn-danger btn-small" onclick="revokeApiKey('{{ api_key.key }}')">
                                <i class="fas fa-trash"></i> Revoke
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div style="text-align: center; padding: 1.5rem; color: #cbd5e1;">
                    <i class="fas fa-key" style="font-size: 1.5rem; margin-bottom: 0.75rem; color: #64748b;"></i>
                    <p style="font-size: 0.9rem;">No API keys generated yet</p>
                </div>
                {% endif %}
            </div>

            <div id="documentation-tab" class="tab-content">
                <h3 style="margin-bottom: 0.75rem; font-size: 1.2rem;">Integration Documentation</h3>
                
                <div class="card">
                    <h4 style="margin-bottom: 0.6rem; font-size: 1.1rem;"><i class="fas fa-code"></i> Complete Lua Implementation</h4>
                    <p style="margin-bottom: 0.75rem; color: #cbd5e1; font-size: 0.9rem;">Here's the full implementation for integrating MooVerify into your Lua scripts:</p>
                    
                    <div class="code-block" id="code1">local MooVerify = {}
MooVerify.APIBaseURL = "https://carminestoat.onpella.app"
MooVerify.APIKey = "YOUR_API_KEY_HERE"  -- Replace with your actual API key

function MooVerify:ValidateKey(key, username)
    local success, result = pcall(function()
        local payload = {
            key = key,
            username = username
        }
        
        local response = game:GetService("HttpService"):RequestAsync({
            Url = self.APIBaseURL .. "/validate_key",
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json",
                ["X-API-Key"] = self.APIKey
            },
            Body = game:GetService("HttpService"):JSONEncode(payload)
        })
        
        if response.Success then
            return game:GetService("HttpService"):JSONDecode(response.Body)
        else
            error("HTTP " .. response.StatusCode .. ": " .. response.StatusMessage)
        end
    end)
    
    if success then
        return result
    else
        return {valid = false, message = "Connection failed: " .. tostring(result)}
    end
end

function MooVerify:CreateVerificationGUI()
    -- Create your GUI here
    local screenGui = Instance.new("ScreenGui")
    screenGui.Parent = game.Players.LocalPlayer.PlayerGui
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 300, 0, 200)
    frame.Position = UDim2.new(0.5, -150, 0.5, -100)
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    frame.Parent = screenGui
    
    -- Add your UI elements here
    local textBox = Instance.new("TextBox")
    textBox.Size = UDim2.new(0, 250, 0, 30)
    textBox.Position = UDim2.new(0, 25, 0, 50)
    textBox.PlaceholderText = "Enter your MOO key..."
    textBox.Parent = frame
    
    local verifyButton = Instance.new("TextButton")
    verifyButton.Size = UDim2.new(0, 250, 0, 30)
    verifyButton.Position = UDim2.new(0, 25, 0, 100)
    verifyButton.Text = "Verify Key"
    verifyButton.Parent = frame
    
    verifyButton.MouseButton1Click:Connect(function()
        local key = textBox.Text:upper()
        local username = game.Players.LocalPlayer.Name
        
        local result = self:ValidateKey(key, username)
        
        if result.valid then
            -- Key is valid, load your script
            print("Key validated successfully!")
            -- loadstring(game:HttpGet("YOUR_MAIN_SCRIPT_URL"))()
        else
            -- Key is invalid
            warn("Key validation failed: " .. result.message)
        end
    end)
    
    return screenGui
end

-- Initialize the system
return MooVerify</div>
                    <button class="copy-btn" onclick="copyCode('code1')">Copy</button>

                    <h4 style="margin: 1.25rem 0 0.6rem 0; font-size: 1.1rem;"><i class="fas fa-cogs"></i> Basic Usage Example</h4>
                    <div class="code-block" id="code2">-- Simple implementation for your script
local MooVerify = require(script.Parent.MooVerify)  -- Adjust path as needed

-- Set your API key (get this from your MooVerify dashboard)
MooVerify.APIKey = "your_actual_api_key_here"

-- Validate a key
local key = "MOO-XXX-XXX-XXX-XXX"  -- User's input
local username = game.Players.LocalPlayer.Name

local result = MooVerify:ValidateKey(key, username)

if result.valid then
    print("✅ Key validated! Loading script...")
    -- Load your main script here
    -- loadstring(game:HttpGet("YOUR_SCRIPT_URL"))()
else
    warn("❌ Key invalid: " .. result.message)
    -- Show error to user
end</div>
                    <button class="copy-btn" onclick="copyCode('code2')">Copy</button>

                    <h4 style="margin: 1.25rem 0 0.6rem 0; font-size: 1.1rem;"><i class="fas fa-shield-alt"></i> Key Validation Rules</h4>
                    <ul style="color: #cbd5e1; margin-left: 1.25rem; margin-bottom: 0.75rem; font-size: 0.9rem;">
                        <li>Keys must be in format: MOO-XXX-XXX-XXX-XXX</li>
                        <li>Keys expire after 6 hours</li>
                        <li>Each key can only be used by one username</li>
                        <li>Keys are case-insensitive</li>
                        <li>Rate limiting: 10 requests per minute per IP</li>
                    </ul>

                    <h4 style="margin: 1.25rem 0 0.6rem 0; font-size: 1.1rem;"><i class="fas fa-wrench"></i> Error Handling</h4>
                    <div class="code-block" id="code3">-- Proper error handling example
local function validateUserKey(key, username)
    local result = MooVerify:ValidateKey(key, username)
    
    if result.valid then
        return true, "Key validated successfully"
    else
        -- Handle specific error cases
        if string.find(result.message, "expired", 1, true) then
            return false, "Key has expired. Please generate a new one."
        elseif string.find(result.message, "not found", 1, true) then
            return false, "Invalid key. Please check and try again."
        elseif string.find(result.message, "does not belong", 1, true) then
            return false, "This key is assigned to a different user."
        else
            return false, "Validation failed: " .. result.message
        end
    end
end</div>
                    <button class="copy-btn" onclick="copyCode('code3')">Copy</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.getElementById(tabName).classList.add('active');
        
        event.target.classList.add('active');
    }

    function generateApiKey() {
        fetch('/user/generate_api_key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('New API Key: ' + data.api_key + '\n\nMake sure to copy it now! It will not be shown again.');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }

    function revokeApiKey(apiKey) {
        if (confirm('Are you sure you want to revoke this API key?')) {
            fetch('/user/revoke_api_key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }
    }

    function copyCode(elementId) {
        const codeElement = document.getElementById(elementId);
        const text = codeElement.textContent;
        
        navigator.clipboard.writeText(text).then(() => {
            const originalText = event.target.textContent;
            event.target.textContent = 'Copied!';
            event.target.style.background = 'rgba(34, 197, 94, 0.2)';
            event.target.style.color = '#22c55e';
            
            setTimeout(() => {
                event.target.textContent = originalText;
                event.target.style.background = 'rgba(30, 41, 59, 0.9)';
                event.target.style.color = '#cbd5e1';
            }, 2000);
        });
    }
</script>
{% endblock %}
